<!-- BY FRANS -->
<!-- 1.0.1.0 -->
<!-- 9.08.2025 -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Konsmon Chat — multiroom (dark)</title>
    <link rel="icon" href="gfx/radioactive_icon.png" type="image/x-icon">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #0f1112;
            --panel: #131516;
            --muted: #2f3334;
            --card: #0f1213;
            --accent: #0ea5ff;
            --accent-hover: #0284c7;
            --text: #e6eef3;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: Inter,Arial,Helvetica,sans-serif;
            background: var(--bg);
            color: var(--text)
        }

        .app {
            height: 94vh;
            width: 96vw;
            margin: 1vh auto;
            display: flex;
            gap: 14px;
            align-items: stretch
        }

        .sidebar {
            width: 300px;
            min-width: 200px;
            background: var(--panel);
            border: 1px solid var(--muted);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column
        }

            .sidebar h2 {
                margin: 4px 0 10px 6px;
                font-size: 15px
            }

        .chat-list {
            flex: 1;
            overflow: auto;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .chat-item {
            background: linear-gradient(180deg,#0d1112,#111315);
            border: 1px solid var(--muted);
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

            .chat-item:hover {
                outline: 2px solid rgba(14,165,255,0.08)
            }

        .chat-title {
            font-weight: 600
        }

        .chat-meta {
            font-size: 12px;
            opacity: .75
        }

        .sidebar-footer {
            margin-top: 10px;
            display: flex;
            gap: 8px
        }

        .btn {
            padding: 8px 10px;
            border-radius: 6px;
            border: 0;
            cursor: pointer
        }

        .btn-primary {
            background: var(--accent);
            color: #002;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--muted);
            color: var(--text)
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0; 
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--muted);
            border-radius: 8px;
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; 
        }

        #chatArea {
            display: none;
            flex: 1;
            flex-direction: column;
            min-height: 0;
            height: 100%;
        }

        .welcome {
            margin: auto;
            max-width: 760px;
            width: 72%;
            background: var(--card);
            border-radius: 8px;
            padding: 24px;
            border: 1px solid var(--muted);
            text-align: center
        }

            .welcome h3 {
                margin: 0 0 12px
            }

        .inputs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 12px
        }

            .inputs input {
                padding: 8px;
                border-radius: 6px;
                border: 1px solid var(--muted);
                background: var(--muted);
                color: var(--text)
            }

        .chat-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px
        }

            .chat-top .meta {
                font-size: 13px;
                opacity: .8
            }

        .messages {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 14px;
            border-radius: 6px;
            background: linear-gradient(180deg,#070808,#0a0b0c);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            display: inline-block;
            max-width: 72%;
            padding: 8px 12px;
            border-radius: 10px;
            background: #02475e;
            color: var(--text);
            word-wrap: break-word
        }

        .meta-line {
            font-size: 12px;
            opacity: .85;
            margin-bottom: 6px
        }

        .input-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            align-items: center
        }

        .nick-input {
            width: 22%;
            min-width: 120px
        }

            .nick-input input {
                width: 100%;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid var(--muted);
                background: var(--muted);
                color: var(--text)
            }

        .msg-input textarea {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--muted);
            background: #0f1415;
            color: var(--text);
            resize: none;
            height: 42px;
            line-height: 1.4;
            font-family: inherit;
        }


            .msg-input input {
                flex: 1;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid var(--muted);
                background: #0f1415;
                color: var(--text)
            }

        .send-btn {
            padding: 10px 14px;
            border-radius: 6px;
            border: 0;
            background: var(--accent);
            cursor: pointer
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10
        }

        .modal {
            background: var(--card);
            padding: 18px;
            border-radius: 8px;
            border: 1px solid var(--muted);
            min-width: 320px
        }

            .modal h4 {
                margin: 0 0 8px
            }

            .modal .row {
                display: flex;
                flex-direction: column;
                gap: 6px;
                margin-bottom: 8px
            }

        /* small screens */
        @media(max-width:900px) {
            .app {
                flex-direction: column;
                height: 95vh
            }

            .sidebar {
                width: 100%;
                min-width: unset;
                height: 180px;
                order: 2
            }

            .main {
                order: 1
            }

            .welcome {
                width: 92%
            }

            .nick-input {
                width: 30%
            }
        }
    </style>
</head>
<body>
    <h1 style="width:96vw;max-width:1200px;margin:8px auto 0;color:var(--text); margin-left: 29px">KONSMON CHAT WEBSITE ☢</h1>

    <div class="app">
        <div class="sidebar">
            <h2>CHAT LIST: </h2>
            <div id="chatList" class="chat-list">Loading...</div>
            <div class="sidebar-footer">
                <button id="btnCreate" class="btn btn-primary">Create new</button>
                <button id="btnRefresh" class="btn btn-ghost">Refresh</button>
            </div>
        </div>

        <div class="main">
            <div class="panel" id="mainPanel">

                <div id="welcomeArea" class="welcome">
                    <h3>Choose a chat or create new one</h3>
                    <p>Create a chat (name + password) or join an existing one by clicking it from the list on the left.</p>
                    <div class="inputs">
                        <button id="createQuick" class="btn btn-primary">Create new chat</button>
                        <div style="align-self:center">— or —</div>
                        <div style="display:flex;gap:6px;align-items:center">
                            <input id="searchInput" placeholder="Search..." />
                            <button id="searchBtn" class="btn btn-ghost">Search</button>
                        </div>
                    </div>
                </div>

                <div id="chatArea" style="display:none;flex-direction:column;height:100%">
                    <div class="chat-top">
                        <div>
                            <strong id="chatTitle">—</strong>
                            <div id="chatSubtitle" class="meta">ID: —</div>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center">
                            <button id="leaveBtn" class="btn btn-ghost">Leave</button>
                            <button id="deleteBtn" class="btn" style="background:#b91c1c;color:white">Delete chat</button>
                        </div>
                    </div>

                    <div id="messages" class="messages"></div>

                    <div class="input-row">
                        <div class="nick-input"><input id="nicknameInput" placeholder="Your nick..." /></div>
                        <div class="msg-input">
                            <textarea id="messageInput" placeholder="Type here... "></textarea>
                            <button id="sendBtn" class="send-btn">Send</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modal" class="modal-backdrop">
        <div class="modal" id="modalContent"></div>
    </div>



    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBeDzJgPfga58CNlEFriKkxVBG-d04JXO4",
            authDomain: "konsmon-website.firebaseapp.com",
            databaseURL: "https://konsmon-website-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "konsmon-website",
            storageBucket: "konsmon-website.firebasestorage.app",
            messagingSenderId: "1004639372000",
            appId: "1:1004639372000:web:49980358b5ac43526e8685",
            measurementId: "G-WJE8C8CY3E"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let adminPassword = null;

        //ADMIN PASS
        db.ref('admin/password').once('value').then(snap => {
            adminPassword = snap.val() || '';
        }).catch(err => {
            console.error('admin passworld was not found', err);
        });


        // UI refs
        const chatListEl = document.getElementById('chatList');
        const btnCreate = document.getElementById('btnCreate');
        const btnRefresh = document.getElementById('btnRefresh');
        const createQuick = document.getElementById('createQuick');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        const welcomeArea = document.getElementById('welcomeArea');
        const chatArea = document.getElementById('chatArea');
        const chatTitle = document.getElementById('chatTitle');
        const chatSubtitle = document.getElementById('chatSubtitle');
        const messagesEl = document.getElementById('messages');
        const nicknameInput = document.getElementById('nicknameInput');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const deleteBtn = document.getElementById('deleteBtn');

        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');



        // State
        let chatsCache = {};
        let currentChatId = null;
        let currentChatRef = null;
        let messagesRef = null;

        function showModal(html) { modalContent.innerHTML = html; modal.style.display = 'flex'; }
        function closeModal() { modal.style.display = 'none'; modalContent.innerHTML = ''; }
        function escapeHtml(text) { return String(text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }



        // Render list
        const chatsRef = db.ref('chats');
        chatsRef.on('value', snap => { chatsCache = snap.val() || {}; renderChatList(searchInput.value.trim()); });

        function renderChatList(filter) {
            chatListEl.innerHTML = '';
            const entries = Object.entries(chatsCache);
            if (entries.length === 0) { chatListEl.textContent = 'No chats yet. Create one.'; return; }
            const filtered = entries.filter(([id, c]) => !filter || (c.name || '').toLowerCase().includes(filter.toLowerCase()));
            if (filtered.length === 0) { chatListEl.textContent = 'No chats found.'; return; }
            filtered.forEach(([id, chat]) => {
                const el = document.createElement('div'); el.className = 'chat-item';
                el.innerHTML = `<div style="min-width:0"><div class=\"chat-title\">${escapeHtml(chat.name)}</div><div class=\"chat-meta\">${chat.desc || ''}</div></div><div style=\"text-align:right;font-size:12px;color:rgba(255,255,255,.75)\">ID:${id.slice(0, 6)}</div>`;
                el.onclick = () => attemptJoin(id);
                chatListEl.appendChild(el);
            });
        }

        // Create modal
        function openCreateModal() {
            showModal(`
                <h4>Create new chat</h4>
                <div class="row"><label>Name</label><input id="newName" placeholder="e.g. my_new_chat" /></div>
                <div class="row"><label>Password</label><input id="newPass" placeholder="optional password" type="password" /></div>
                <div class="row"><label>Delete password</label><input id="newDeletePass" placeholder="password to delete chat" type="password" /></div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                <button id="cancelCreate" class="btn btn-ghost">Cancel</button>
                <button id="confirmCreate" class="btn btn-primary">Create</button>
                </div>
    `       );

            document.getElementById('cancelCreate').onclick = closeModal;
            document.getElementById('confirmCreate').onclick = () => {
                const name = String(document.getElementById('newName').value || '').trim();
                const pass = String(document.getElementById('newPass').value || '');
                const deletePass = String(document.getElementById('newDeletePass').value || '');
                if (!name) { alert('Provide chat name'); return; }
                if (!deletePass) { alert('Provide delete password'); return; }
                const newRef = chatsRef.push();
                newRef.set({
                    name: name,
                    password: pass,
                    deletePassword: deletePass,
                    createdAt: Date.now()
                }).then(() => {
                    closeModal();
                    attemptJoin(newRef.key, true, pass);
                }).catch(e => alert('Error: ' + e.message));
            }
        }


        btnCreate.onclick = openCreateModal; createQuick.onclick = openCreateModal; btnRefresh.onclick = () => renderChatList(searchInput.value.trim());




        // Join modal
        function attemptJoin(id, skipPrompt = false, knownPass = '') {
            const chat = chatsCache[id];
            if (!chat) {
                alert('Chat not found');
                return;
            }

            if (!chat.password || chat.password.trim() === '') {
                joinChat(id);
                return;
            }

            if (skipPrompt) {
                joinChat(id);
                return;
            }

            showModal(`
            <h4>Join ${escapeHtml(chat.name)}</h4>
            <div class="row">
            <label>Password</label>
            <input id="joinPass" type="password" placeholder="Password"/>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="cancelJoin" class="btn btn-ghost">Cancel</button>
            <button id="confirmJoin" class="btn btn-primary">Join</button>
            </div>
    `       );

            document.getElementById('cancelJoin').onclick = closeModal;
            document.getElementById('confirmJoin').onclick = () => {
                const p = String(document.getElementById('joinPass').value || '');

                if (p === (chat.password || '') || p === adminPassword) {
                    closeModal();
                    joinChat(id, p);
                } else {
                    alert('Wrong password');
                }
            };
        }






        function joinChat(id) {
            currentChatId = id;
            currentChatRef = db.ref('chats/' + id);
            const chat = chatsCache[id] || {};
            chatTitle.textContent = chat.name || '—';
            chatSubtitle.textContent = 'ID: ' + id;
            welcomeArea.style.display = 'none';
            chatArea.style.display = 'flex';
            messagesEl.innerHTML = '';

            // Detach previous
            if (messagesRef) messagesRef.off();
            messagesRef = db.ref(`chats/${id}/messages`);

            // Listen for additions
            messagesRef.on('child_added', snap => {
                const m = snap.val();
                const msgWrap = document.createElement('div');
                const meta = document.createElement('div'); meta.className = 'meta-line';
                meta.textContent = `[${m.time || ''}] ${m.nickname || 'Anon'}`;
                const bubble = document.createElement('div'); bubble.className = 'message';
                bubble.textContent = m.text || '';
                msgWrap.appendChild(meta);
                msgWrap.appendChild(bubble);
                messagesEl.appendChild(msgWrap);

                // Auto-scroll
                const distanceFromBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight;
                const shouldAutoScroll = distanceFromBottom < 100;
                if (shouldAutoScroll) {
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }
            });
        }

        leaveBtn.onclick = () => { if (!currentChatId) return; if (!confirm('Leave chat?')) return; detachChat(); }
        function detachChat() { if (messagesRef) messagesRef.off(); currentChatId = null; currentChatRef = null; messagesEl.innerHTML = ''; chatArea.style.display = 'none'; welcomeArea.style.display = 'block'; chatTitle.textContent = '—'; chatSubtitle.textContent = '—'; }






        deleteBtn.onclick = () => {
            if (!currentChatId) return;
            const chat = chatsCache[currentChatId];
            if (!chat) { alert('Chat data not found'); return; }

            showModal(`
            <h4>Delete chat: ${escapeHtml(chat.name)}</h4>
            <div class="row">
            <label>Delete password</label>
            <input id="deletePassInput" type="password" placeholder="Enter delete or admin password" />
            </div>
               <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="cancelDelete" class="btn btn-ghost">Cancel</button>
            <button id="confirmDelete" class="btn btn-primary" style="background:#b91c1c;color:white">Delete</button>
            </div>
    `       );

            document.getElementById('cancelDelete').onclick = closeModal;
            document.getElementById('confirmDelete').onclick = () => {
            const enteredPass = String(document.getElementById('deletePassInput').value || '');


            if (enteredPass === (chat.deletePassword || '') || enteredPass === adminPassword) {
                    db.ref('chats/' + currentChatId).remove()
                        .then(() => {
                            alert('Chat deleted');
                            closeModal();
                            detachChat();
                        })
                        .catch(e => alert('Error: ' + e.message));
                } else {
                    alert('Wrong delete password');
                }
            };
        };

        f




        function sendMessage() {
            if (!currentChatId) { alert('Join a chat first'); return; }
            let text = String(messageInput.value || '').trim();
            const wrapLimit = 100;
            if (text.length > wrapLimit) {
                let wrapped = '';
                for (let i = 0; i < text.length; i += wrapLimit) {
                    wrapped += text.slice(i, i + wrapLimit) + '\n';
                }
                text = wrapped.trimEnd();
            }

            const nick = String(nicknameInput.value || '').trim() || 'Anon';
            if (!text) return;
            const t = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            db.ref(`chats/${currentChatId}/messages`).push({ nickname: nick, text: text, time: t }).then(() => { messageInput.value = ''; messageInput.focus(); }).catch(e => alert('Error: ' + e.message));
        }

        sendBtn.onclick = sendMessage;

        messageInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });



        searchBtn.onclick = () => renderChatList(searchInput.value.trim()); searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') renderChatList(searchInput.value.trim()); });

        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });





        // Initial
        renderChatList();
    </script>
</body>
</html>

